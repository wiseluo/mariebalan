<link rel="stylesheet" type="text/css" href="/static/admin/css/order.css">
<script class="resources library" src="/static/admin/js/area.js" type="text/javascript"></script>
<section class="scrollable padder">
    <ul class="breadcrumb no-border no-radius b-b b-light pull-in">
        <li><a href="./"><i class="fa fa-home"></i> 首页</a></li>
        <li><a href="{:url('order/orderlist')}">订单管理</a></li>
        <li><a >订单详情</a></li>
        <li><a >修改订单</a></li>
    </ul>
   
    <section class="panel panel-default">
     	<div class="orderdetail">
     		
     		<ul class="listfour">
     		<input type="hidden" id='order_id' value='{$order_id}'>
     		<input type="hidden" id="order_logpay" value="{$order.logistics}">
            <input type="hidden" id="order_dispay" value="{$order.dispay}">
            <input type="hidden" id="order_usermoney" value="{$order->usermoney}">
     			<li><label>订单总额:</label><span><strong>{$order.money+$order.logistics}</strong>(商品总价:{$order.money}，运费:{$order.logistics})</span></li>
     			<li><label>收货人:</label><input type="text" id="order_sh" name="" value="{$order_shouhuo.consignee}"></li>
     			<li><label>手机:</label><input type="text" id="order_tel" name="" value="{$order_shouhuo.address}"></li>
     			<li><label>地址:</label>
     				<select id='address_one'>
     					<option>浙江</option>
     				</select>
     				<select id='address_two'>
     					<option>金华</option>
     				</select>
     				<select id='address_three'>
     					<option>义乌</option>
     				</select>
     				<input type="text" id='address_four' name="" value="">
     			</li>
     			<li><label>配送物流:</label><input type="text" id='order_pswl' name="" value="{$order.logistics}"></li>
     			<li><label>支付方式:</label></label>
                    <select id='order_zffs' data-val = "{$order.paytype}">
                        <option value="">选择支付类型</option>
                        {foreach name="paytype" item="v" key="k"}
                        <option value="{$k}" {if($order['paytype'] eq $v)}selected="selected"{/if}>{$v}</option>
                        {/foreach} 
                    </select>
               </li>
     			<li><label>发票抬头:</label><input type="text" id='order_fptt' name="" value="{$order.invoice}"></li>
     			<li><label>添加商品:</label><button class="addproduct" data-id='{$order_id}'>添加商品</button></li>
     		</ul>
     		<div class="productlist">
                <label>商品列表:</label>
                <div class="table-responsive">
                    <table class="table table-striped b-t b-light text-sm tableproduct">
                        <thead>
                        <tr>
                          
                            <th width="40%">商品名称 </th>
                            <th width="10%">规格</th>
                            <th width="15%">价格</th>
                            <th width="10%">数量</th>
                            <th width="15%">操作</th>
                           
                        </tr>
                        </thead>
                        <tbody id='productsarr'>
                        {foreach name="order_product" key="k" item="v"}
                        <tr>
                        	<input type="hidden" class='orderpro' value="{$v.id}">
                            <td><img src="/static/admin/images/test.jpg" width="40"><a href="">{$v.title}</a></td>
                            <td></td>
                            <td><input type="" name="" class='products_price' data-id={$v.id} value="{$v.price}"></td>
                            <td><input type="" name="" class='products_count' data-id={$v.id} value="{$v.count}"></td>
                            <td><span class="btn btn-warning btn-xs" title="删除" data-id={$v.id}><i class="fa fa-trash-o"></i></span></td>
                            <!-- <input type="hidden" class="orderpay" value="{$v.price*100*$v.count}">        -->
                        </tr>
                       	{/foreach}
                       	
                        </tbody>
                    </table>
                </div>
            </div>
     		<div class="clear"></div>
     		<div class="textareabox" style="border-top: 1px dashed #eaeaea; padding-top: 20px;">
     			<label>管理员备注:</label>
     			<textarea id='order_beizhu'>{$order.remark}</textarea>
     			
     		</div>
            <div class="submitbutton">
                 <button class="submitproduct">确认提交</button>
            </div>
        
     	</div>
     
       
    
    </section>
</section>

<div class="modal fade" id="modal-form">
    <div class="modal-dialog" style="width:800px;">
        <div class="modal-content">
            <div class="modal-body addproducts">
                <form role="form" id="productinfo">
                    
                 </form>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
 
<script type="text/javascript">
$(function(){
      $(".addproduct").on("click",this,function(){
      	var orderid = $(this).data('id');
      	//alert(orderid);
        $.ajax({
            type:'GET',
            url:'/admin/order/sproducts?id='+orderid,
            cache:false,
            success: function(data){
            	//console.log(data);
                $("#productinfo").html(data);
                $("#modal-form").modal("show");
            }
        })
    })

      $('.btn-xs').click(function(){
      	if(!confirm('你确定要删除吗？'))return false;
      	var id=$(this).attr("data-id");
      	$(this).parent().parent().remove();
      	$.ajax({
            type:'post',
            url:'/admin/order/removeorderpro?id='+id,
            cache:false,
            success: function(data){
            	//console.log(data);
            	//window.location.reload();
            }
        })
      })

    //提交
    $('.submitproduct').click(function(){
    	var orderid = $('#order_id').val();
    	var prosid = '';
    	var proscount = '';
    	var prosprice = '';
    	var order = {};
    	var shouhuo = {};
    	var products = {};
    	var orderpay = 0;     //订单总额
    	var orderlog = 0;     //物流费用

    	$('.products_count').each(function(){
    		prosid += $(this).data('id')+",";
    		proscount += $(this).val()+",";
    	});
    	$('.products_price').each(function(){
    		prosprice += $(this).val()+",";
    		//价格 * 数量
    		orderpay += ($(this).val()) * ($(this).parent().next().find('.products_count').val());//订单商品总价，已转为 元
    	});
    	orderpay = 100 * orderpay;   //存入订单中，转为 分
    	orderlog = 100 * $('#order_logpay').val();     //单位 分  订单物流费用
        orderdis = 100 * $('#order_dispay').val();     //单位 分  调整费用
        usermoney = 100 * $('#order_usermoney').val();     //单位 分  用户余额

		//alert(orderlog);return;
    	prosid = (prosid.substring(prosid.length-1)==',')?prosid.substring(0,prosid.length-1):prosid;    //订单商品id
    	proscount = (proscount.substring(proscount.length-1)==',')?proscount.substring(0,proscount.length-1):proscount;  //订单商品数量
    	prosprice = (prosprice.substring(prosprice.length-1)==',')?prosprice.substring(0,prosprice.length-1):prosprice;  //订单商品价格

    	shouhuo['consignee'] = $('#order_sh').val();
    	shouhuo['telphone'] = $('#order_tel').val();
    	//shouhuo['address'] = $('#address_one').val()+$('#address_two').val()+$('#address_three').val()+$('#address_four').val();
        shouhuo['province'] = $('#address_one').val();
        shouhuo['city'] = $('#address_two').val();
        shouhuo['town'] = $('#address_three').val();
        shouhuo['address'] = $('#address_four').val();

    	order['logistics'] = $('#order_pswl').val();
    	order['paytype'] = $('#order_zffs').val();
    	order['invoice'] = $('#order_fptt').val();
    	order['remark'] = $('#order_beizhu').val();
    	order['orderpay'] = orderpay;
    	order['payment'] =  parseInt(orderlog) + parseInt(orderdis) + parseInt(orderpay) - parseInt(usermoney); //应付（物流+调整+商品总价-余额）;
    	//order['orderpay'] = $('#order_pay').val();  //商品总价;

    	products['prosid'] = prosid;
    	products['proscount'] = proscount;
    	products['prosprice'] = prosprice;
    	$.ajax({
    		type:'post',
    		url:'/admin/order/addorder?id='+orderid,
    		cache:false,
    		data:{
    			order:order,
    			shouhuo:shouhuo,
    			products:products
    		},
    		
    		success:function(data){
    			//console.log(data);
    			window.location.href="/admin/order/orderdetails?id="+orderid;
    		}

    	});
    })
})
</script>